apiVersion: 1

groups:
  - orgId: 1
    name: worker-ocr-alerts
    folder: Doc Pipeline/Workers
    interval: 1m
    rules:
      # ============================================================
      # AVAILABILITY ALERTS
      # ============================================================

      - uid: worker-ocr-down
        title: OCR Worker Down
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job="doc-pipeline-worker-ocr"} == 0
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
        noDataState: Alerting
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "OCR Worker is down"
          description: "The OCR worker has been unreachable for more than 2 minutes"
        labels:
          severity: critical
          service: doc-pipeline
          worker: ocr

      - uid: worker-ocr-high-error-rate
        title: OCR High Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(doc_pipeline_jobs_processed_total{operation="ocr",status="error"}[5m]))
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(doc_pipeline_jobs_processed_total{operation="ocr"}[5m]))
          - refId: C
            datasourceUid: __expr__
            model:
              type: math
              expression: $A / $B
              conditions:
                - evaluator:
                    params: [0.1]
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: "High OCR error rate detected"
          description: "OCR error rate is {{ $values.C.Value | printf \"%.1f\" }}% (threshold: 10%)"
        labels:
          severity: warning
          service: doc-pipeline
          worker: ocr

      # ============================================================
      # PERFORMANCE ALERTS
      # ============================================================

      - uid: worker-ocr-high-latency
        title: OCR High Processing Time
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.95, rate(doc_pipeline_worker_processing_seconds_bucket{operation="ocr"}[5m])) > 30
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: "OCR processing time is very high"
          description: "P95 processing time is above 30 seconds"
        labels:
          severity: warning
          service: doc-pipeline
          worker: ocr

      - uid: worker-ocr-queue-depth-high
        title: OCR Queue Depth High
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: doc_pipeline_queue_depth{job="doc-pipeline-worker-ocr"} > 10
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: "OCR queue is backing up"
          description: "Queue depth is {{ $values.A.Value }} jobs (threshold: 10)"
        labels:
          severity: warning
          service: doc-pipeline
          worker: ocr

      # ============================================================
      # WEBHOOK ALERTS
      # ============================================================

      - uid: worker-ocr-webhook-failures
        title: OCR Webhook Delivery Failures
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(doc_pipeline_webhook_deliveries_total{status="failed"}[5m]) > 0.1
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: "Webhook deliveries are failing"
          description: "Webhook failure rate is elevated"
        labels:
          severity: warning
          service: doc-pipeline
          worker: ocr
