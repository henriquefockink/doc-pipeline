apiVersion: 1

groups:
  - orgId: 1
    name: worker-docid-alerts
    folder: Doc Pipeline/Workers Alerts
    interval: 1m
    rules:
      # ============================================================
      # AVAILABILITY ALERTS
      # ============================================================

      - uid: worker-docid-down
        title: DocID Worker Down
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job="doc-pipeline-worker-docid"} == 0
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
        noDataState: Alerting
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "DocID Worker is down"
          description: "The classification worker has been unreachable for more than 2 minutes"
        labels:
          severity: critical
          service: doc-pipeline
          worker: docid

      - uid: worker-docid-high-error-rate
        title: DocID High Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(doc_pipeline_jobs_processed_total{job="doc-pipeline-worker-docid",status="error"}[5m]))
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(doc_pipeline_jobs_processed_total{job="doc-pipeline-worker-docid"}[5m]))
          - refId: C
            datasourceUid: __expr__
            model:
              type: math
              expression: $A / $B
              conditions:
                - evaluator:
                    params: [0.1]
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: "High classification worker error rate"
          description: "Classification worker error rate is {{ $values.C.Value | printf \"%.1f\" }}% (threshold: 10%)"
        labels:
          severity: warning
          service: doc-pipeline
          worker: docid

      # ============================================================
      # PERFORMANCE ALERTS
      # ============================================================

      - uid: worker-docid-high-latency
        title: DocID High Processing Time
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.95, sum(rate(doc_pipeline_worker_processing_seconds_bucket{job="doc-pipeline-worker-docid"}[5m])) by (le)) > 30
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: "Classification processing time is very high"
          description: "P95 processing time is above 30 seconds"
        labels:
          severity: warning
          service: doc-pipeline
          worker: docid

      - uid: worker-docid-queue-depth-high
        title: DocID Queue Depth High
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: doc_pipeline_queue_depth{job="doc-pipeline-worker-docid"} > 10
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: "Classification queue is backing up"
          description: "Queue depth is {{ $values.A.Value }} jobs (threshold: 10)"
        labels:
          severity: warning
          service: doc-pipeline
          worker: docid

      # ============================================================
      # BUSINESS METRICS ALERTS
      # ============================================================

      - uid: worker-docid-low-confidence
        title: DocID Low Confidence
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.5, sum(rate(doc_pipeline_classification_confidence_bucket[10m])) by (le)) < 0.7
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 10m
        annotations:
          summary: "Classification confidence is low"
          description: "Median classification confidence is below 70%"
        labels:
          severity: warning
          service: doc-pipeline
          worker: docid
